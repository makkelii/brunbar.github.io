<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Mini Racing ‚Äì Gayming Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #111;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
    }

    #game-container {
      position: relative;
      width: 100%;
      height: 100%;
      touch-action: none;
      background: radial-gradient(circle at top, #333 0, #111 60%, #000 100%);
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 0.75rem;
      padding: 1.5rem 1.2rem 1.2rem;
      background: radial-gradient(circle at top, rgba(0,0,0,0.9), rgba(0,0,0,0.85));
      text-align: center;
      z-index: 10;
      overflow-y: auto;
    }

    .overlay.hidden {
      display: none;
    }

    .overlay h1 {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }

    .overlay p {
      margin-bottom: 0.25rem;
      opacity: 0.9;
    }

    .btn {
      display: inline-block;
      border-radius: 999px;
      padding: 0.7rem 1.4rem;
      border: none;
      margin: 0.2rem;
      font-size: 0.95rem;
      font-weight: 600;
      background: linear-gradient(135deg, #ff9800, #ff5722);
      color: #111;
      cursor: pointer;
      box-shadow: 0 0.3rem 0.9rem rgba(0, 0, 0, 0.6);
      white-space: nowrap;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #03a9f4, #00bcd4);
      color: #011017;
    }

    .btn.small {
      padding: 0.45rem 1rem;
      font-size: 0.8rem;
      box-shadow: none;
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .section-title {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }

    .hint {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .level-select {
      width: 100%;
      max-width: 720px;
      margin-top: 0.4rem;
    }

    .level-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem;
      width: 100%;
    }

    .level-card {
      background: linear-gradient(145deg, rgba(40,40,55,0.96), rgba(8,8,16,0.96));
      border-radius: 1rem;
      padding: 0.55rem 0.6rem;
      border: 1px solid rgba(255,255,255,0.14);
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      cursor: pointer;
      position: relative;
    }

    .level-card.locked {
      opacity: 0.4;
      cursor: default;
    }

    .level-name {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .level-meta {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .level-best-time,
    .level-best-score {
      font-size: 0.75rem;
      margin-top: 0.1rem;
      opacity: 0.8;
    }

    .level-badge {
      position: absolute;
      top: 0.3rem;
      right: 0.45rem;
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: rgba(76,175,80,0.2);
      border: 1px solid rgba(129,199,132,0.6);
      text-transform: uppercase;
    }

    .level-badge.locked {
      background: rgba(158,158,158,0.1);
      border-color: rgba(189,189,189,0.6);
    }

    .level-badge.current {
      background: rgba(3,169,244,0.18);
      border-color: rgba(129,212,250,0.7);
    }

    .car-customization {
      width: 100%;
      max-width: 720px;
      margin-top: 0.3rem;
    }

    .car-skin-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      justify-content: center;
    }

    .car-skin {
      width: 80px;
      padding: 0.25rem;
      border-radius: 0.9rem;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.1rem;
      font-size: 0.7rem;
    }

    .car-skin-preview {
      width: 100%;
      height: 28px;
      border-radius: 0.7rem;
      position: relative;
      overflow: hidden;
    }

    .car-skin-preview-body {
      position: absolute;
      inset: 3px 5px;
      border-radius: 0.6rem;
    }

    .car-skin-preview-details {
      position: absolute;
      left: 6px;
      right: 6px;
      top: 4px;
      height: 5px;
      border-radius: 999px;
    }

    .car-skin.selected {
      border-color: #ffeb3b;
      box-shadow: 0 0 0 1px rgba(255,235,59,0.6);
    }

    .menu-actions {
      margin-top: 0.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      justify-content: center;
    }

    #controls {
      position: absolute;
      inset-inline: 0;
      bottom: 0;
      height: 25vh;
      display: flex;
      justify-content: space-between;
      padding: 1.3rem;
      z-index: 5;
      pointer-events: none;
    }

    .control-btn {
      pointer-events: auto;
      width: 30vw;
      max-width: 180px;
      height: 100%;
      border-radius: 1.5rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: radial-gradient(circle at top, rgba(255,255,255,0.16), rgba(0,0,0,0.75));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #fff;
      user-select: none;
    }

    .control-btn:active {
      background: radial-gradient(circle at top, rgba(255,255,255,0.25), rgba(0,0,0,0.85));
      transform: scale(0.97);
    }

    #hud {
      position: absolute;
      top: 0.7rem;
      left: 0.7rem;
      right: 0.7rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.85rem;
      text-shadow: 0 1px 2px #000;
      z-index: 4;
    }

    #hud span {
      background: rgba(0, 0, 0, 0.5);
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    #hud-right {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    #hud-audio {
      cursor: pointer;
      user-select: none;
    }

    #status-overlay h1 {
      margin-top: 1rem;
      margin-bottom: 0.4rem;
    }

    #status-overlay .btn-row {
      margin-top: 0.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      justify-content: center;
    }

    #status-extra {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 0.1rem;
    }

    @media (min-width: 768px) {
      .overlay { justify-content: flex-start; }
      #game-container {
        max-width: 900px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game"></canvas>

    <div id="hud">
      <span id="hud-level">Taso: 1</span>
      <div id="hud-right">
        <span id="hud-distance">Matkaa maaliin: ‚Äì</span>
        <span id="hud-time">Aika: 0.0 s</span>
        <span id="hud-score">Pisteet: 0</span>
        <span id="hud-audio" title="√Ñ√§net p√§√§lle/pois">üîä</span>
      </div>
    </div>

    <div id="controls">
      <div id="btn-left" class="control-btn">‚üµ</div>
      <div id="btn-right" class="control-btn">‚ü∂</div>
    </div>

    <div id="menu" class="overlay">
      <h1>Mini Racing</h1>
      <p>3-kaistaa, pehme√§t liikkeet, kolikot & tasot. Mobiilissa kosketus, koneella nuolin√§pp√§imet / A‚ÄìD.</p>
      <p class="hint">Esc: takaisin valikkoon. Tallennus selaimen muistiin.</p>

      <div class="level-select">
        <div class="section-title">Tason valinta</div>
        <div id="level-list" class="level-list"></div>
        <p class="hint">Lukitut kartat avautuvat, kun ajat edellisen maaliin.</p>
      </div>

      <div class="car-customization">
        <div class="section-title">Auto</div>
        <div id="car-skin-list" class="car-skin-list"></div>
        <p class="hint">Auton v√§ri s√§ilyy seuraavalla kerralla.</p>
      </div>

      <div class="menu-actions">
        <button id="btn-quick-start" class="btn">Jatka / nopea aloitus</button>
        <button id="btn-reset-progress" class="btn secondary small">Nollaa edistyminen</button>
      </div>
    </div>

    <div id="status-overlay" class="overlay hidden">
      <h1 id="status-title">Taso l√§p√§isty!</h1>
      <p id="status-text"></p>
      <div id="status-extra"></div>
      <div class="btn-row">
        <button id="btn-primary" class="btn"></button>
        <button id="btn-secondary" class="btn secondary hidden"></button>
        <button id="btn-back-menu" class="btn small">Takaisin valikkoon</button>
      </div>
    </div>
  </div>

  <script>
    // DOM
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const hudLevel = document.getElementById("hud-level");
    const hudDistance = document.getElementById("hud-distance");
    const hudTime = document.getElementById("hud-time");
    const hudScore = document.getElementById("hud-score");
    const hudAudio = document.getElementById("hud-audio");

    const menuOverlay = document.getElementById("menu");
    const levelListEl = document.getElementById("level-list");
    const carSkinListEl = document.getElementById("car-skin-list");
    const btnQuickStart = document.getElementById("btn-quick-start");
    const btnResetProgress = document.getElementById("btn-reset-progress");

    const statusOverlay = document.getElementById("status-overlay");
    const statusTitle = document.getElementById("status-title");
    const statusText = document.getElementById("status-text");
    const statusExtra = document.getElementById("status-extra");
    const btnPrimary = document.getElementById("btn-primary");
    const btnSecondary = document.getElementById("btn-secondary");
    const btnBackMenu = document.getElementById("btn-back-menu");

    const btnLeft = document.getElementById("btn-left");
    const btnRight = document.getElementById("btn-right");

    // Storage keys (v3 = uusi, helpompi peli)
    const STORAGE_KEY_PROGRESS = "miniRacingProgress_v3";
    const STORAGE_KEY_CAR = "miniRacingCarSkin_v3";
    const STORAGE_KEY_AUDIO = "miniRacingAudio_v1";

    // Tasot (8 karttaa)
    const levels = [
      { id: 0, name: "Taso 1 ‚Äì L√§mpp√§ri",            speed: 170, distance: 600,  obstacleInterval: 1300, coinInterval: 1100, difficulty: 1 },
      { id: 1, name: "Taso 2 ‚Äì Kaupunkisuora",       speed: 190, distance: 900,  obstacleInterval: 1200, coinInterval: 1000, difficulty: 2 },
      { id: 2, name: "Taso 3 ‚Äì Ruuhkakaista",        speed: 215, distance: 1100, obstacleInterval: 1100, coinInterval: 950,  difficulty: 3 },
      { id: 3, name: "Taso 4 ‚Äì Y√∂myrsky",            speed: 240, distance: 1300, obstacleInterval: 1000, coinInterval: 900,  difficulty: 4 },
      { id: 4, name: "Taso 5 ‚Äì Moottoritien haamu",  speed: 265, distance: 1500, obstacleInterval: 930,  coinInterval: 850,  difficulty: 5 },
      { id: 5, name: "Taso 6 ‚Äì Neon-bulevardi",      speed: 290, distance: 1800, obstacleInterval: 880,  coinInterval: 800,  difficulty: 6 },
      { id: 6, name: "Taso 7 ‚Äì Hyperkaista",         speed: 320, distance: 2100, obstacleInterval: 830,  coinInterval: 750,  difficulty: 7 },
      { id: 7, name: "Taso 8 ‚Äì Viimeinen sprintti",  speed: 350, distance: 2400, obstacleInterval: 780,  coinInterval: 720,  difficulty: 8 }
    ];

    const carSkins = [
      { id: "neon",   name: "Neon Turbo",    body: "#03dac6", details: "#ffeb3b" },
      { id: "lava",   name: "Lava GT",       body: "#ff5252", details: "#ffeb3b" },
      { id: "royal",  name: "Royal Racer",   body: "#7c4dff", details: "#ffeb3b" },
      { id: "shadow", name: "Shadow X",      body: "#222222", details: "#ffab40" },
      { id: "arctic", name: "Arctic Bolt",   body: "#eceff1", details: "#42a5f5" }
    ];

    let progress = {
      highestUnlocked: 0,
      bestTimes: {},
      bestScores: {}
    };

    let currentCarSkinId = "neon";

    let gameState = "menu"; // menu, playing, levelComplete, gameOver, finished
    let currentLevelIndex = 0;

    const road = {
      x: 0,
      width: 0,
      lanes: 3,
      laneWidth: 0
    };

    const player = {
      x: 0,
      y: 0,
      width: 40,
      height: 70,
      lane: 1,
      targetLane: 1,
      moveSpeed: 900 // px/s sivuttaisliikkeen maksimi
    };

    let obstacles = [];
    let obstacleTimer = 0;
    let distanceLeft = 0;
    let lastTime = 0;
    let scrollOffset = 0;
    let elapsedTime = 0;

    let coins = [];
    let coinTimer = 0;
    let score = 0;
    const COIN_VALUE = 100;

    let inputLeftActive = false;
    let inputRightActive = false;

    // Audio
    let audioEnabled = true;
    let audioCtx = null;
    let masterGain = null;
    let engineGain = null;
    let sfxGain = null;
    let engineOsc = null;

    function loadAudioSetting() {
      try {
        const v = localStorage.getItem(STORAGE_KEY_AUDIO);
        audioEnabled = v === "0" ? false : true;
      } catch {
        audioEnabled = true;
      }
    }

    function saveAudioSetting() {
      try {
        localStorage.setItem(STORAGE_KEY_AUDIO, audioEnabled ? "1" : "0");
      } catch {}
    }

    function updateAudioHUD() {
      hudAudio.textContent = audioEnabled ? "üîä" : "üîá";
    }

    function initAudioContext() {
      if (!audioEnabled) return;
      if (audioCtx) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;

      audioCtx = new AC();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.7;
      masterGain.connect(audioCtx.destination);

      engineGain = audioCtx.createGain();
      engineGain.gain.value = 0.0;
      engineGain.connect(masterGain);

      sfxGain = audioCtx.createGain();
      sfxGain.gain.value = 0.8;
      sfxGain.connect(masterGain);
    }

    function startEngineSound() {
      if (!audioEnabled) return;
      initAudioContext();
      if (!audioCtx || engineOsc) return;

      engineOsc = audioCtx.createOscillator();
      engineOsc.type = "sawtooth";
      engineOsc.frequency.value = 80;
      engineOsc.connect(engineGain);

      const now = audioCtx.currentTime;
      engineGain.gain.setValueAtTime(0.0, now);
      engineGain.gain.linearRampToValueAtTime(0.22, now + 0.4);

      engineOsc.start();
    }

    function stopEngineSound() {
      if (!audioCtx || !engineOsc) return;
      const now = audioCtx.currentTime;
      engineGain.gain.cancelScheduledValues(now);
      engineGain.gain.setTargetAtTime(0.0, now, 0.08);
      engineOsc.stop(now + 0.15);
      engineOsc = null;
    }

    function updateEnginePitch(level) {
      if (!audioEnabled || !audioCtx || !engineOsc) return;
      const base = 60 + level.speed * 0.15;
      const steerBoost = (inputLeftActive || inputRightActive) ? 30 : 0;
      const freq = base + steerBoost;
      engineOsc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.05);
    }

    function playBeep(freq, duration, volume) {
      if (!audioEnabled) return;
      initAudioContext();
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      gain.gain.value = volume;
      osc.connect(gain);
      gain.connect(sfxGain || masterGain);
      const now = audioCtx.currentTime;
      osc.start(now);
      gain.gain.setValueAtTime(volume, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.stop(now + duration + 0.02);
    }

    function playCoinSound() { playBeep(880, 0.12, 0.5); }
    function playClickSound() { playBeep(420, 0.08, 0.3); }

    function playWinSound() {
      playBeep(1320, 0.18, 0.5);
      setTimeout(() => playBeep(1760, 0.22, 0.4), 80);
    }

    function playCrashSound() {
      if (!audioEnabled) return;
      initAudioContext();
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.value = 80;
      gain.gain.value = 0.7;
      osc.connect(gain);
      gain.connect(sfxGain || masterGain);
      const now = audioCtx.currentTime;
      osc.start(now);
      gain.gain.setValueAtTime(0.7, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.25);
      osc.frequency.exponentialRampToValueAtTime(20, now + 0.25);
      osc.stop(now + 0.3);
    }

    // Storage
    function loadProgress() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_PROGRESS);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (typeof parsed.highestUnlocked === "number") {
          progress.highestUnlocked = parsed.highestUnlocked;
        }
        if (parsed.bestTimes && typeof parsed.bestTimes === "object") {
          progress.bestTimes = parsed.bestTimes;
        }
        if (parsed.bestScores && typeof parsed.bestScores === "object") {
          progress.bestScores = parsed.bestScores;
        }
      } catch (e) {
        console.warn("Progress load fail", e);
      }
    }

    function saveProgress() {
      try {
        localStorage.setItem(STORAGE_KEY_PROGRESS, JSON.stringify(progress));
      } catch (e) {
        console.warn("Progress save fail", e);
      }
    }

    function loadCarSkin() {
      try {
        const id = localStorage.getItem(STORAGE_KEY_CAR);
        if (id && carSkins.some(s => s.id === id)) currentCarSkinId = id;
      } catch {}
    }

    function saveCarSkin() {
      try {
        localStorage.setItem(STORAGE_KEY_CAR, currentCarSkinId);
      } catch {}
    }

    function getCurrentCarSkin() {
      return carSkins.find(s => s.id === currentCarSkinId) || carSkins[0];
    }

    function formatTime(seconds) {
      if (!isFinite(seconds)) return "‚Äì";
      const ms = Math.round(seconds * 100);
      const totalSeconds = Math.floor(ms / 100);
      const minutes = Math.floor(totalSeconds / 60);
      const secs = totalSeconds % 60;
      const hundredths = ms % 100;
      if (minutes > 0) {
        return `${minutes}:${secs.toString().padStart(2, "0")}.${hundredths.toString().padStart(2, "0")} min`;
      } else {
        return `${secs}.${hundredths.toString().padStart(2, "0")} s`;
      }
    }

    // Layout
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const margin = Math.max(canvas.width * 0.12, 40);
      road.x = margin;
      road.width = canvas.width - margin * 2;
      road.laneWidth = road.width / road.lanes;
      const baseWidth = road.laneWidth * 0.38;
      player.width = baseWidth;
      player.height = baseWidth * 1.8;
      player.y = canvas.height - player.height - canvas.height * 0.12;
      updatePlayerTargetX();
      player.x = player.targetX;
    }

    function laneCenterX(laneIndex) {
      return road.x + road.laneWidth * (laneIndex + 0.5);
    }

    function updatePlayerTargetX() {
      player.targetX = laneCenterX(player.targetLane) - player.width / 2;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function updateScoreHUD() {
      hudScore.textContent = `Pisteet: ${score}`;
    }

    function resetLevel(index) {
      const level = levels[index];
      currentLevelIndex = index;
      distanceLeft = level.distance;
      obstacles = [];
      obstacleTimer = 0;
      scrollOffset = 0;
      elapsedTime = 0;
      coins = [];
      coinTimer = 0;
      score = 0;
      player.lane = 1;
      player.targetLane = 1;
      updatePlayerTargetX();
      player.x = player.targetX;

      hudLevel.textContent = `Taso: ${index + 1}`;
      hudDistance.textContent = `Matkaa maaliin: ${Math.ceil(distanceLeft)} m`;
      hudTime.textContent = `Aika: 0.0 s`;
      updateScoreHUD();
      updateLevelMenuUI();
    }

    function startLevel(index) {
      playClickSound();
      resetLevel(index);
      gameState = "playing";
      menuOverlay.classList.add("hidden");
      statusOverlay.classList.add("hidden");
      startEngineSound();
    }

    function unlockNextLevelAndUpdateRecords() {
      const level = levels[currentLevelIndex];
      const levelId = level.id.toString();
      const oldBestTime = progress.bestTimes[levelId];
      const oldBestScore = progress.bestScores[levelId];

      if (oldBestTime === undefined || elapsedTime < oldBestTime) {
        progress.bestTimes[levelId] = elapsedTime;
      }
      if (oldBestScore === undefined || score > oldBestScore) {
        progress.bestScores[levelId] = score;
      }

      if (currentLevelIndex < levels.length - 1) {
        if (progress.highestUnlocked < currentLevelIndex + 1) {
          progress.highestUnlocked = currentLevelIndex + 1;
        }
      }

      saveProgress();
    }

    function showStatusOverlay(type) {
      statusOverlay.classList.remove("hidden");
      btnSecondary.classList.add("hidden");
      statusExtra.textContent = "";
      stopEngineSound();

      const level = levels[currentLevelIndex];
      const levelId = level.id.toString();
      const bestTime = progress.bestTimes[levelId];
      const bestScore = progress.bestScores[levelId];
      const currentTimeStr = formatTime(elapsedTime);

      if (type === "levelComplete") {
        gameState = "levelComplete";
        unlockNextLevelAndUpdateRecords();
        playWinSound();

        const newBestTime = bestTime === undefined || elapsedTime < bestTime;
        const newBestScore = bestScore === undefined || score > bestScore;

        const updatedBestTime = progress.bestTimes[levelId];
        const updatedBestScore = progress.bestScores[levelId];

        let s = `Maali! Aikasi: ${currentTimeStr}. `;
        if (newBestTime && bestTime !== undefined) {
          s += `Uusi aikaenn√§tys (vanha ${formatTime(bestTime)}). `;
        } else if (bestTime === undefined) {
          s += `Ensimm√§inen aika t√§ll√§ tasolla. `;
        } else {
          s += `Paras aikasi: ${formatTime(bestTime)}. `;
        }

        s += `Pisteet: ${score}. `;
        if (newBestScore && bestScore !== undefined) {
          s += `Uusi piste-enn√§tys (vanha ${bestScore}).`;
        } else if (bestScore === undefined) {
          s += `Ensimm√§inen pistetulos t√§ll√§ tasolla.`;
        } else {
          s += `Paras pistem√§√§r√§si: ${bestScore}.`;
        }

        statusTitle.textContent = "Taso l√§p√§isty!";
        statusText.textContent = s;

        if (currentLevelIndex < levels.length - 1) {
          statusExtra.textContent = `Seuraavaksi: ${levels[currentLevelIndex + 1].name}`;
          btnPrimary.textContent = "Seuraava taso ‚Üí";
          btnSecondary.textContent = "Yrit√§ taso uudestaan";
          btnSecondary.classList.remove("hidden");

          btnPrimary.onclick = () => {
            statusOverlay.classList.add("hidden");
            startLevel(currentLevelIndex + 1);
          };
          btnSecondary.onclick = () => {
            statusOverlay.classList.add("hidden");
            startLevel(currentLevelIndex);
          };
        } else {
          gameState = "finished";
          statusExtra.textContent = "L√§p√§isit kaikki kartat ‚Äì mestari kuski!";
          btnPrimary.textContent = "Pelaa alusta";
          btnPrimary.onclick = () => {
            statusOverlay.classList.add("hidden");
            startLevel(0);
          };
        }
      } else if (type === "gameOver") {
        gameState = "gameOver";
        playCrashSound();
        statusTitle.textContent = "T√∂rm√§ys!";
        statusText.textContent = `Auto romuna. Aikasi ennen t√∂rm√§yst√§: ${currentTimeStr}, pisteet: ${score}.`;
        btnPrimary.textContent = "Yrit√§ uudestaan";
        btnPrimary.onclick = () => {
          statusOverlay.classList.add("hidden");
          startLevel(currentLevelIndex);
        };
      }

      btnBackMenu.onclick = () => {
        playClickSound();
        statusOverlay.classList.add("hidden");
        gameState = "menu";
        menuOverlay.classList.remove("hidden");
        updateLevelMenuUI();
      };
    }

    function rectsOverlap(a, b) {
      return !(
        a.x + a.width < b.x ||
        a.x > b.x + b.width ||
        a.y + a.height < b.y ||
        a.y > b.y + b.height
      );
    }

    function spawnObstacle() {
      const level = levels[currentLevelIndex];
      const lane = Math.floor(Math.random() * road.lanes);
      const laneCenter = laneCenterX(lane);
      const width = road.laneWidth * 0.34;
      const height = width * 1.7;

      obstacles.push({
        x: laneCenter - width / 2,
        y: -height - 20,
        width,
        height,
        speed: level.speed * (0.9 + Math.random() * 0.25)
      });
    }

    function spawnCoin() {
      const level = levels[currentLevelIndex];
      const lane = Math.floor(Math.random() * road.lanes);
      const laneCenter = laneCenterX(lane);
      const size = road.laneWidth * 0.28;

      coins.push({
        x: laneCenter - size / 2,
        y: -size - 10,
        width: size,
        height: size,
        speed: level.speed * 0.9
      });
    }

    function update(dt) {
      if (gameState !== "playing") return;
      const level = levels[currentLevelIndex];

      // Pelaajan pehme√§ lane-liike
      const dx = player.targetX - player.x;
      const maxStep = player.moveSpeed * dt;
      if (Math.abs(dx) <= maxStep) {
        player.x = player.targetX;
      } else {
        player.x += Math.sign(dx) * maxStep;
      }

      scrollOffset += level.speed * dt;
      elapsedTime += dt;
      hudTime.textContent = `Aika: ${formatTime(elapsedTime)}`;

      obstacleTimer -= dt * 1000;
      if (obstacleTimer <= 0) {
        spawnObstacle();
        obstacleTimer = level.obstacleInterval * (0.85 + Math.random() * 0.4);
      }

      coinTimer -= dt * 1000;
      if (coinTimer <= 0) {
        spawnCoin();
        coinTimer = level.coinInterval * (0.8 + Math.random() * 0.5);
      }

      // P√§ivit√§ esteet
      const playerHit = {
        x: player.x + player.width * 0.15,
        y: player.y + player.height * 0.1,
        width: player.width * 0.7,
        height: player.height * 0.8
      };

      for (let i = obstacles.length - 1; i >= 0; i--) {
        const o = obstacles[i];
        o.y += o.speed * dt;
        if (o.y > canvas.height + 60) {
          obstacles.splice(i, 1);
          continue;
        }
        const oHit = {
          x: o.x + o.width * 0.1,
          y: o.y + o.height * 0.1,
          width: o.width * 0.8,
          height: o.height * 0.8
        };
        if (rectsOverlap(playerHit, oHit)) {
          showStatusOverlay("gameOver");
          return;
        }
      }

      // P√§ivit√§ kolikot
      for (let i = coins.length - 1; i >= 0; i--) {
        const c = coins[i];
        c.y += c.speed * dt;
        if (c.y > canvas.height + 40) {
          coins.splice(i, 1);
          continue;
        }
        const cHit = {
          x: c.x + c.width * 0.2,
          y: c.y + c.height * 0.2,
          width: c.width * 0.6,
          height: c.height * 0.6
        };
        if (rectsOverlap(playerHit, cHit)) {
          score += COIN_VALUE;
          updateScoreHUD();
          playCoinSound();
          coins.splice(i, 1);
        }
      }

      // Matka
      const distanceStep = level.speed * dt * 0.6;
      distanceLeft -= distanceStep;
      if (distanceLeft < 0) distanceLeft = 0;
      hudDistance.textContent = `Matkaa maaliin: ${Math.ceil(distanceLeft)} m`;

      if (distanceLeft <= 0) {
        showStatusOverlay("levelComplete");
      }

      updateEnginePitch(level);
    }

    function drawRoad() {
      const h = canvas.height;
      const grad = ctx.createLinearGradient(0, 0, 0, h);
      grad.addColorStop(0, "#20232a");
      grad.addColorStop(1, "#13151a");
      ctx.fillStyle = grad;
      ctx.fillRect(road.x, 0, road.width, h);

      ctx.strokeStyle = "#555";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(road.x, 0);
      ctx.lineTo(road.x, h);
      ctx.moveTo(road.x + road.width, 0);
      ctx.lineTo(road.x + road.width, h);
      ctx.stroke();

      const dashHeight = 30;
      const gap = 30;
      ctx.strokeStyle = "#eee";
      ctx.lineWidth = 4;
      ctx.setLineDash([dashHeight, gap]);

      for (let lane = 1; lane < road.lanes; lane++) {
        const x = road.x + road.laneWidth * lane;
        ctx.beginPath();
        const offset = scrollOffset % (dashHeight + gap);
        ctx.moveTo(x, -dashHeight + offset);
        ctx.lineTo(x, h + dashHeight + offset);
        ctx.stroke();
      }

      ctx.setLineDash([]);
    }

    function drawCar(car, bodyColor, detailColor) {
      ctx.save();
      ctx.translate(car.x + car.width / 2, car.y + car.height / 2);
      const bw = car.width;
      const bh = car.height;

      ctx.fillStyle = bodyColor;
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      if (ctx.roundRect) {
        ctx.beginPath();
        ctx.roundRect(-bw / 2, -bh / 2, bw, bh, 8);
        ctx.fill();
        ctx.stroke();
      } else {
        ctx.fillRect(-bw / 2, -bh / 2, bw, bh);
        ctx.strokeRect(-bw / 2, -bh / 2, bw, bh);
      }

      ctx.fillStyle = "rgba(10,20,30,0.9)";
      const winH = bh * 0.28;
      ctx.fillRect(-bw * 0.35, -winH / 2, bw * 0.7, winH);

      ctx.fillStyle = detailColor;
      const lightW = bw * 0.22;
      const lightH = 6;
      ctx.fillRect(-bw / 2 + 4, -bh / 2 + 6, lightW, lightH);
      ctx.fillRect(bw / 2 - lightW - 4, -bh / 2 + 6, lightW, lightH);

      ctx.fillStyle = "#ff1744";
      ctx.fillRect(-bw / 2 + 4, bh / 2 - lightH - 6, lightW, lightH);
      ctx.fillRect(bw / 2 - lightW - 4, bh / 2 - lightH - 6, lightW, lightH);

      const grad = ctx.createLinearGradient(-bw / 2, 0, bw / 2, 0);
      grad.addColorStop(0, "rgba(255,255,255,0.1)");
      grad.addColorStop(0.5, "rgba(255,255,255,0)");
      grad.addColorStop(1, "rgba(0,0,0,0.35)");
      ctx.fillStyle = grad;
      ctx.fillRect(-bw / 2, -bh / 2, bw, bh);

      ctx.restore();
    }

    function drawCoin(c) {
      const cx = c.x + c.width / 2;
      const cy = c.y + c.height / 2;
      const r = c.width / 2;
      const grad = ctx.createRadialGradient(cx - r * 0.3, cy - r * 0.3, r * 0.1, cx, cy, r);
      grad.addColorStop(0, "#fff9c4");
      grad.addColorStop(0.4, "#ffeb3b");
      grad.addColorStop(1, "#f9a825");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "rgba(255,255,255,0.7)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, r * 0.65, 0, Math.PI * 2);
      ctx.stroke();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawRoad();

      for (const c of coins) drawCoin(c);
      for (const o of obstacles) drawCar(o, "#f44336", "#ffc107");

      const skin = getCurrentCarSkin();
      drawCar(player, skin.body, skin.details);

      const grad = ctx.createLinearGradient(0, canvas.height * 0.7, 0, canvas.height);
      grad.addColorStop(0, "rgba(0,0,0,0)");
      grad.addColorStop(1, "rgba(0,0,0,0.5)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, canvas.height * 0.7, canvas.width, canvas.height * 0.3);
    }

    function loop(ts) {
      if (!lastTime) lastTime = ts;
      const dt = Math.min((ts - lastTime) / 1000, 0.035);
      lastTime = ts;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    // PC-ohjaus: lane step per painallus
    window.addEventListener("keydown", (e) => {
      if (e.repeat) return;
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
        moveLane(-1);
        inputLeftActive = true;
      } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
        moveLane(1);
        inputRightActive = true;
      } else if (e.key === "Escape") {
        if (gameState === "playing") {
          gameState = "menu";
          menuOverlay.classList.remove("hidden");
          stopEngineSound();
          updateLevelMenuUI();
        }
      }
    });

    window.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
        inputLeftActive = false;
      } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
        inputRightActive = false;
      }
    });

    function moveLane(delta) {
      const newLane = Math.max(0, Math.min(road.lanes - 1, player.targetLane + delta));
      if (newLane !== player.targetLane) {
        player.targetLane = newLane;
        updatePlayerTargetX();
        playClickSound();
      }
    }

    function attachTapButton(btn, dir) {
      const onPress = (e) => {
        e.preventDefault();
        moveLane(dir);
      };
      btn.addEventListener("touchstart", onPress);
      btn.addEventListener("mousedown", onPress);
    }

    attachTapButton(btnLeft, -1);
    attachTapButton(btnRight, 1);

    hudAudio.addEventListener("click", () => {
      audioEnabled = !audioEnabled;
      saveAudioSetting();
      updateAudioHUD();
      playClickSound();
      if (!audioEnabled) {
        stopEngineSound();
      } else if (gameState === "playing") {
        startEngineSound();
      }
    });

    function updateLevelMenuUI() {
      levelListEl.innerHTML = "";
      const highest = progress.highestUnlocked;
      levels.forEach((level, index) => {
        const card = document.createElement("div");
        const locked = index > highest;
        card.className = "level-card" + (locked ? " locked" : "");
        const nameEl = document.createElement("div");
        nameEl.className = "level-name";
        nameEl.textContent = level.name;
        card.appendChild(nameEl);

        const metaEl = document.createElement("div");
        metaEl.className = "level-meta";
        const maxStars = 5;
        const normalized = Math.min(maxStars, Math.max(1, Math.round(level.difficulty * maxStars / levels.length)));
        const stars = "‚òÖ".repeat(normalized) + "‚òÜ".repeat(maxStars - normalized);
        metaEl.textContent = `Vaikeus: ${stars}`;
        card.appendChild(metaEl);

        const timeVal = progress.bestTimes[level.id.toString()];
        const timeEl = document.createElement("div");
        timeEl.className = "level-best-time";
        timeEl.textContent = timeVal !== undefined ? `Paras aika: ${formatTime(timeVal)}` : "Paras aika: ‚Äì";
        card.appendChild(timeEl);

        const scoreVal = progress.bestScores[level.id.toString()];
        const scoreEl = document.createElement("div");
        scoreEl.className = "level-best-score";
        scoreEl.textContent = scoreVal !== undefined ? `Paras pisteet: ${scoreVal}` : "Paras pisteet: ‚Äì";
        card.appendChild(scoreEl);

        const badge = document.createElement("div");
        badge.className = "level-badge";
        if (locked) {
          badge.classList.add("locked");
          badge.textContent = "Lukittu";
        } else if (index === currentLevelIndex) {
          badge.classList.add("current");
          badge.textContent = "Valittu";
        } else {
          badge.textContent = "Avoin";
        }
        card.appendChild(badge);

        if (!locked) {
          card.addEventListener("click", () => {
            currentLevelIndex = index;
            playClickSound();
            updateLevelMenuUI();
          });
        }

        levelListEl.appendChild(card);
      });
    }

    function buildCarSkinUI() {
      carSkinListEl.innerHTML = "";
      carSkins.forEach((skin) => {
        const wrap = document.createElement("div");
        wrap.className = "car-skin";
        if (skin.id === currentCarSkinId) wrap.classList.add("selected");

        const prev = document.createElement("div");
        prev.className = "car-skin-preview";
        const body = document.createElement("div");
        body.className = "car-skin-preview-body";
        body.style.background = skin.body;
        const det = document.createElement("div");
        det.className = "car-skin-preview-details";
        det.style.background = skin.details;
        prev.appendChild(body);
        prev.appendChild(det);

        const label = document.createElement("div");
        label.textContent = skin.name;

        wrap.appendChild(prev);
        wrap.appendChild(label);

        wrap.addEventListener("click", () => {
          currentCarSkinId = skin.id;
          saveCarSkin();
          playClickSound();
          buildCarSkinUI();
        });

        carSkinListEl.appendChild(wrap);
      });
    }

    btnQuickStart.addEventListener("click", () => {
      const highest = progress.highestUnlocked;
      let idx = currentLevelIndex;
      if (idx > highest) idx = highest;
      startLevel(idx);
    });

    btnResetProgress.addEventListener("click", () => {
      if (confirm("Haluatko varmasti nollata edistymisen, ajat ja pisteet?")) {
        progress = { highestUnlocked: 0, bestTimes: {}, bestScores: {} };
        saveProgress();
        playClickSound();
        updateLevelMenuUI();
      }
    });

    function init() {
      loadAudioSetting();
      updateAudioHUD();
      loadProgress();
      loadCarSkin();
      buildCarSkinUI();
      updateLevelMenuUI();
      if (currentLevelIndex > progress.highestUnlocked) {
        currentLevelIndex = progress.highestUnlocked;
      }
      resetLevel(currentLevelIndex);
      requestAnimationFrame(loop);
    }

    init();
  </script>
</body>
</html>
